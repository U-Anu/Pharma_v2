{% extends 'admin_base.html' %}
{% block body_block %}
{% load static %}

<!-- FontAwesome Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

<style>
  .none-value-row {
    background-color: #fff3cd !important; /* Yellow warning background */
  }
  
  .none-value-cell {
    color: #dc3545; /* Red for None values */
    font-weight: bold;
  }
  
  .sortable-header {
    cursor: pointer;
  }
  
  .sortable-header:hover {
    background-color: #0b5ed7 !important;
  }
</style>

<div class="container mt-4">

  <!-- HEADER -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
    <h2 class="text-primary">Product List</h2>

    <div class="d-flex gap-2">
      <a href="{% url 'update_all_products' %}" class="btn btn-primary">
        <i class="fa fa-upload"></i> Upload Products
      </a>
      <a href="{% url 'product_create' %}" class="btn btn-success">
        <i class="fa fa-plus"></i> Create Product
      </a>
    </div>
  </div>

  <!-- ðŸ” SMART COMMON SEARCH -->
  <form method="get" class="mb-3">
    <div class="input-group">
      <input
        type="text"
        name="q"
        class="form-control"
        placeholder="Search product (e.g. gliclazide 30 + metformin)"
        value="{{ request.GET.q }}"
        autocomplete="off"
      >
      <button class="btn btn-primary">
        <i class="fa fa-search"></i>
      </button>
    </div>
  </form>

  <!-- Simple Filter Button -->
  <div class="mb-3">
    {% if filter_missing %}
      <a href="?" class="btn btn-secondary btn-sm">
        <i class="fa fa-list"></i> Show All Products
      </a>
    {% else %}
      <a href="?filter=missing" class="btn btn-warning btn-sm">
        <i class="fa fa-exclamation-triangle"></i> Show Products with Missing Fields
      </a>
    {% endif %}
  </div>

  <!-- PRODUCT TABLE -->
  <div class="table-responsive">
    <table class="table table-striped table-bordered text-center align-middle">
      <thead>
        <tr>
          <th class="bg-primary text-white">Product ID</th>
          <th class="bg-primary text-white">Product Name</th>
          <th class="bg-primary text-white">Composition</th>
          <th class="bg-primary text-white">Type</th>
          <th class="bg-primary text-white">Price</th>
          <th class="bg-primary text-white">Pack Size</th>
          <th class="bg-primary text-white">GST</th>
          <th class="bg-primary text-white">Quantity</th>
          <th class="bg-primary text-white">Actions</th>
        </tr>
      </thead>

      <tbody>
        {% for product in products %}
       <tr data-id="{{ product.id }}" class="{% if product.has_missing_fields %}none-value-row{% endif %}">
  
  <td>{{ product.product_id }}</td>

  <td data-field="name" style="white-space: normal; word-break: break-word;">{{ product.name }}</td>
  <td data-field="composition_name" style="white-space: normal; word-break: break-word;">{{ product.composition_name }}</td>
  <td data-field="product_type">{{ product.product_type }}</td>
  <td data-field="price">{{ product.price }}</td>
  <td data-field="pack_size">{{ product.pack_size }}</td>
  <td data-field="GST">{{ product.GST }}</td>

  <td>{{ product.quantity }}</td>

  <td>
    <button class="btn btn-sm btn-primary edit-btn">
      <i class="fa fa-edit"></i>
    </button>

    <button class="btn btn-sm btn-success save-btn d-none">
      <i class="fa fa-save"></i>
    </button>

    <button class="btn btn-sm btn-secondary cancel-btn d-none">
      <i class="fa fa-times"></i>
    </button>
    <a href="{% url 'product_delete' product.id %}"
               class="btn btn-sm btn-danger">
              <i class="fa fa-trash"></i>
            </a>
  </td>
</tr>

        {% endfor %}
      </tbody>
    </table>
  </div>

</div>
<script>
document.querySelectorAll(".edit-btn").forEach(btn => {
  btn.addEventListener("click", function () {
    const row = this.closest("tr");
    row.querySelectorAll("[data-field]").forEach(td => {
      const value = td.innerText.trim();
      td.dataset.original = value;
      td.innerHTML = `<input class="form-control form-control-sm" value="${value}">`;
    });

    row.querySelector(".edit-btn").classList.add("d-none");
    row.querySelector(".save-btn").classList.remove("d-none");
    row.querySelector(".cancel-btn").classList.remove("d-none");
  });
});

document.querySelectorAll(".cancel-btn").forEach(btn => {
  btn.addEventListener("click", function () {
    const row = this.closest("tr");
    row.querySelectorAll("[data-field]").forEach(td => {
      td.innerText = td.dataset.original;
    });

    row.querySelector(".edit-btn").classList.remove("d-none");
    row.querySelector(".save-btn").classList.add("d-none");
    row.querySelector(".cancel-btn").classList.add("d-none");
  });
});

document.querySelectorAll(".save-btn").forEach(btn => {
  btn.addEventListener("click", function () {
    const row = this.closest("tr");
    const productId = row.dataset.id;

    const data = new FormData();
    row.querySelectorAll("[data-field]").forEach(td => {
      data.append(td.dataset.field, td.querySelector("input").value);
    });

    fetch(`/products/ajax-update/${productId}/`, {
      method: "POST",
      headers: { "X-CSRFToken": "{{ csrf_token }}" },
      body: data
    })
    .then(res => res.json())
    .then(resp => {
      if (resp.success) {
        row.querySelectorAll("[data-field]").forEach(td => {
          td.innerText = td.querySelector("input").value;
        });
      } else {
        alert(resp.error);
      }

      row.querySelector(".edit-btn").classList.remove("d-none");
      row.querySelector(".save-btn").classList.add("d-none");
      row.querySelector(".cancel-btn").classList.add("d-none");
    });
  });
});
</script>

{% endblock %}