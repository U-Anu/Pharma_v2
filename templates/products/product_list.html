{% extends 'admin_base.html' %}
{% block body_block %}
{% load static %}

<!-- FontAwesome Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

<style>
  .none-value-row {
    background-color: #fff3cd !important; /* Yellow warning background */
    border-left: 4px solid #ffc107; /* Yellow border on left */
  }
  
  .none-value-cell {
    color: #dc3545; /* Red for None values */
    font-weight: bold;
  }
  
  .sortable-header {
    cursor: pointer;
  }
  
  .sortable-header:hover {
    background-color: #0b5ed7 !important;
  }
  
  .sort-indicator {
    margin-left: 5px;
    font-size: 0.8em;
  }
</style>

<div class="container mt-4">

  <!-- HEADER -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
    <h2 class="text-primary">Product List</h2>

    <div class="d-flex gap-2">
      <a href="{% url 'update_all_products' %}" class="btn btn-primary">
        <i class="fa fa-upload"></i> Upload Products
      </a>
      <a href="{% url 'product_create' %}" class="btn btn-success">
        <i class="fa fa-plus"></i> Create Product
      </a>
      
      <!-- Missing fields counter -->
      {% with missing_count=products|length %}
        {% if filter_missing %}
          <span class="badge bg-warning text-dark align-self-center">
            <i class="fa fa-exclamation-triangle"></i> 
            Showing {{ missing_count }} product(s) with missing fields
          </span>
        {% endif %}
      {% endwith %}
    </div>
  </div>

  <!-- SEARCH AND FILTERS -->
  <div class="row mb-3">
    <div class="col-md-8">
      <form method="get" class="mb-3">
        <input type="hidden" name="sort" value="{{ sort_by }}">
        <input type="hidden" name="order" value="{{ sort_order }}">
        <div class="input-group">
          <input
            type="text"
            name="q"
            class="form-control"
            placeholder="Search product (e.g. gliclazide 30 + metformin)"
            value="{{ request.GET.q }}"
            autocomplete="off"
          >
          <button class="btn btn-primary">
            <i class="fa fa-search"></i>
          </button>
        </div>
      </form>
    </div>
    
    <div class="col-md-4">
      <div class="d-flex gap-2">
        <!-- Filter buttons -->
        {% if filter_missing %}
          <a href="?q={{ current_query|default:'' }}&sort={{ sort_by }}&order={{ sort_order }}" 
             class="btn btn-secondary">
            <i class="fa fa-list"></i> Show All
          </a>
        {% else %}
          <a href="?q={{ current_query|default:'' }}&filter=missing&sort={{ sort_by }}&order={{ sort_order }}" 
             class="btn btn-warning">
            <i class="fa fa-exclamation-triangle"></i> Show Missing Only
          </a>
        {% endif %}
        
        <!-- Quick sort dropdown -->
        <div class="dropdown">
          <button class="btn btn-info dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fa fa-sort"></i> Sort
          </button>
          <ul class="dropdown-menu">
            <li>
              <a class="dropdown-item" href="?q={{ current_query|default:'' }}{% if filter_missing %}&filter=missing{% endif %}&sort=missing_first&order=desc">
                <i class="fa fa-exclamation-triangle"></i> Missing First
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="?q={{ current_query|default:'' }}{% if filter_missing %}&filter=missing{% endif %}&sort=name&order=asc">
                <i class="fa fa-sort-alpha-up"></i> Name A-Z
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="?q={{ current_query|default:'' }}{% if filter_missing %}&filter=missing{% endif %}&sort=name&order=desc">
                <i class="fa fa-sort-alpha-down"></i> Name Z-A
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="?q={{ current_query|default:'' }}{% if filter_missing %}&filter=missing{% endif %}&sort=price&order=desc">
                <i class="fa fa-sort-numeric-down"></i> Price High-Low
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="?q={{ current_query|default:'' }}{% if filter_missing %}&filter=missing{% endif %}&sort=price&order=asc">
                <i class="fa fa-sort-numeric-up"></i> Price Low-High
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="?q={{ current_query|default:'' }}{% if filter_missing %}&filter=missing{% endif %}&sort=quantity&order=desc">
                <i class="fa fa-box"></i> Quantity High-Low
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- PRODUCT TABLE -->
  <div class="table-responsive">
    <table class="table table-striped table-bordered text-center align-middle">
      <thead>
        <tr>
          <th class="bg-primary text-white sortable-header" 
              onclick="toggleSort('name')">
            Product Name
            {% if sort_by == 'name' %}
              <span class="sort-indicator">
                {% if sort_order == 'asc' %}
                  <i class="fa fa-sort-up"></i>
                {% else %}
                  <i class="fa fa-sort-down"></i>
                {% endif %}
              </span>
            {% endif %}
          </th>
          <th class="bg-primary text-white">Product ID</th>
          <th class="bg-primary text-white">Composition</th>
          <th class="bg-primary text-white">Type</th>
          <th class="bg-primary text-white sortable-header" 
              onclick="toggleSort('price')">
            Price
            {% if sort_by == 'price' %}
              <span class="sort-indicator">
                {% if sort_order == 'asc' %}
                  <i class="fa fa-sort-up"></i>
                {% else %}
                  <i class="fa fa-sort-down"></i>
                {% endif %}
              </span>
            {% endif %}
          </th>
          <th class="bg-primary text-white">Pack Size</th>
          <th class="bg-primary text-white">GST</th>
          <th class="bg-primary text-white sortable-header" 
              onclick="toggleSort('quantity')">
            Quantity
            {% if sort_by == 'quantity' %}
              <span class="sort-indicator">
                {% if sort_order == 'asc' %}
                  <i class="fa fa-sort-up"></i>
                {% else %}
                  <i class="fa fa-sort-down"></i>
                {% endif %}
              </span>
            {% endif %}
          </th>
          <th class="bg-primary text-white">Actions</th>
        </tr>
      </thead>

      <tbody>
        {% for product in products %}
        <tr class="{% if product.has_missing_fields %}none-value-row{% endif %}">
          <td style="white-space: normal; word-break: break-word;">
            {{ product.name|default:"-" }}
          </td>
          <td>{{ product.product_id|default:"-" }}</td>
          <td style="white-space: normal; word-break: break-word;">
            {{ product.composition_name|default:"-" }}
          </td>
          <td class="{% if not product.product_type %}none-value-cell{% endif %}">
            {{ product.product_type|default:"None" }}
          </td>
          <td class="{% if not product.price %}none-value-cell{% endif %}">
            {% if product.price %}
              â‚¹{{ product.price|floatformat:2 }}
            {% else %}
              None
            {% endif %}
          </td>
          <td class="{% if not product.pack_size %}none-value-cell{% endif %}">
            {{ product.pack_size|default:"None" }}
          </td>
          <td class="{% if not product.GST %}none-value-cell{% endif %}">
            {% if product.GST %}
              {{ product.GST }}%
            {% else %}
              None
            {% endif %}
          </td>
          <td>
            <span class="badge {% if product.quantity > 0 %}bg-success{% else %}bg-danger{% endif %}">
              {{ product.quantity|default:"0" }}
            </span>
          </td>
          <td>
            <div class="btn-group btn-group-sm">
              <a href="{% url 'product_update' product.id %}"
                 class="btn btn-primary" title="Edit">
                <i class="fa fa-edit"></i>
              </a>
              <a href="{% url 'product_delete' product.id %}"
                 class="btn btn-danger" title="Delete">
                <i class="fa fa-trash"></i>
              </a>
              <a href="{% url 'product_markups' product.id %}"
                 class="btn btn-secondary" title="Pricing">
                <i class="fa fa-percent"></i>
              </a>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="9" class="text-center text-muted py-4">
            <i class="fa fa-search fa-2x mb-2"></i><br>
            No products found{% if filter_missing %} with missing fields{% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

<script>
function toggleSort(column) {
    const urlParams = new URLSearchParams(window.location.search);
    const currentSort = urlParams.get('sort');
    const currentOrder = urlParams.get('order');
    
    let newOrder = 'asc';
    
    if (currentSort === column) {
        // Toggle order if clicking same column
        newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
    } else {
        // Default to ascending for new column
        newOrder = 'asc';
    }
    
    // Update URL parameters
    urlParams.set('sort', column);
    urlParams.set('order', newOrder);
    
    // Keep existing filters
    const q = urlParams.get('q') || '';
    const filter = urlParams.get('filter') || '';
    
    // Build new URL
    let newUrl = '?sort=' + column + '&order=' + newOrder;
    if (q) newUrl += '&q=' + encodeURIComponent(q);
    if (filter) newUrl += '&filter=' + filter;
    
    window.location.href = newUrl;
}

// JavaScript for better UX
document.addEventListener('DOMContentLoaded', function() {
    // Add tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}