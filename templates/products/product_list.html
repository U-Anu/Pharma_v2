{% extends 'admin_base.html' %}
{% block body_block %}
{% load static %}

<!-- FontAwesome Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

<style>
  .none-value-row {
    background-color: #fff3cd !important; /* Yellow warning background */
  }
  
  .none-value-cell {
    color: #dc3545; /* Red for None values */
    font-weight: bold;
  }
  
  .sortable-header {
    cursor: pointer;
  }
  
  .sortable-header:hover {
    background-color: #0b5ed7 !important;
  }
</style>

<div class="container mt-4">

  <!-- HEADER -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
    <h2 class="text-primary">Product List</h2>

    <div class="d-flex gap-2">
      <a href="{% url 'update_all_products' %}" class="btn btn-primary">
        <i class="fa fa-upload"></i> Upload Products
      </a>
      <a href="{% url 'product_create' %}" class="btn btn-success">
        <i class="fa fa-plus"></i> Create Product
      </a>
    </div>
  </div>

  <!-- ðŸ” SMART COMMON SEARCH -->
  <form method="get" class="mb-3">
    <div class="input-group">
      <input
        type="text"
        name="q"
        class="form-control"
        placeholder="Search product (e.g. gliclazide 30 + metformin)"
        value="{{ request.GET.q }}"
        autocomplete="off"
      >
      <button class="btn btn-primary">
        <i class="fa fa-search"></i>
      </button>
    </div>
  </form>

  <!-- Simple Filter Button -->
  <div class="mb-3">
    {% if filter_missing %}
      <a href="?" class="btn btn-secondary btn-sm">
        <i class="fa fa-list"></i> Show All Products
      </a>
    {% else %}
      <a href="?filter=missing" class="btn btn-warning btn-sm">
        <i class="fa fa-exclamation-triangle"></i> Show Products with Missing Fields
      </a>
    {% endif %}
  </div>

  <!-- PRODUCT TABLE -->
  <div class="table-responsive">
    <table class="table table-striped table-bordered text-center align-middle">
      <thead>
        <tr>
          <th class="bg-primary text-white">Product ID</th>
          <th class="bg-primary text-white">Product Name</th>
          <th class="bg-primary text-white">Composition</th>
          <th class="bg-primary text-white">Type</th>
          <th class="bg-primary text-white">Price</th>
          <th class="bg-primary text-white">Pack Size</th>
          <th class="bg-primary text-white">GST</th>
          <th class="bg-primary text-white">Quantity</th>
          <th class="bg-primary text-white">Actions</th>
        </tr>
      </thead>

      <tbody>
        {% for product in products %}
        <tr class="{% if product.has_missing_fields %}none-value-row{% endif %}">
          <td>{{ product.product_id|default:"-" }}</td>
          <td style="white-space: normal; word-break: break-word;">
            {{ product.name|default:"-" }}
          </td>
          <td style="white-space: normal; word-break: break-word;">
            {{ product.composition_name|default:"-" }}
          </td>
          <td class="{% if not product.product_type or product.product_type == '' %}none-value-cell{% endif %}">
            {{ product.product_type|default:"None" }}
          </td>
          <td class="{% if product.price is None %}none-value-cell{% endif %}">
            {% if product.price is not None %}
              {{ product.price }}
            {% else %}
              None
            {% endif %}
          </td>
          <td class="{% if product.pack_size is None %}none-value-cell{% endif %}">
            {% if product.pack_size is not None %}
              {{ product.pack_size }}
            {% else %}
              None
            {% endif %}
          </td>
          <td class="{% if product.GST is None %}none-value-cell{% endif %}">
            {% if product.GST is not None %}
              {{ product.GST }}
            {% else %}
              None
            {% endif %}
          </td>
          <td>{{ product.quantity|default:"0" }}</td>
          <td>
            <a href="{% url 'product_update' product.id %}"
               class="btn btn-sm btn-primary">
              <i class="fa fa-edit"></i>
            </a>
            <a href="{% url 'product_delete' product.id %}"
               class="btn btn-sm btn-danger">
              <i class="fa fa-trash"></i>
            </a>
            <a href="{% url 'product_markups' product.id %}"
               class="btn btn-sm btn-secondary">
              <i class="fa fa-percent"></i>
            </a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="9" class="text-center text-muted">
            No products found
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>
{% endblock %}