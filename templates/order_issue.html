{% extends 'admin_base.html' %}
{% load static %}
{% block body_block %}

<style>
/* ---------- BASE ---------- */
body {
    background: #ffffff;
    font-family: "Segoe UI", Arial, sans-serif;
    font-size: 14px;
    color: #222;
}

/* ---------- PAGE ---------- */
.page {
    max-width: 1400px;
    margin: 20px auto;
}

/* ---------- HEADER ---------- */
.header {
    padding-bottom: 12px;
    margin-bottom: 16px;
    border-bottom: 2px solid #eee;
}

.header h3 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
}

/* ---------- META ---------- */
.meta {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    font-size: 13px;
    gap: 10px 30px;
    margin-bottom: 20px;
}

/* ---------- SPLIT (EQUAL) ---------- */
.split {
    display: grid;
    grid-template-columns: 1fr 1fr;   /* ✅ EQUAL WIDTH */
    gap: 20px;
}

/* ---------- SECTION ---------- */
.section-title {
    font-weight: 600;
    font-size: 14px;
    margin: 14px 0 8px;
    color: #333;
}

/* ---------- TABLE ---------- */
.table-wrap {
    border: 1px solid #e3e3e3;
    border-radius: 4px;
    overflow: hidden;
    background: #ffffff;
}

table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

thead th {
    background: #ece7e7;
    padding: 10px 8px;
    text-align: left;
    font-weight: 600;
    border-bottom: 1px solid #ddd;
    white-space: nowrap;
}

tbody td {
    padding: 9px 8px;
    border-bottom: 1px solid #eee;
    vertical-align: middle;
}

tbody tr:last-child td {
    border-bottom: none;
}

tbody tr:hover {
    background: #fafafa;
}

tbody tr.selected {
    background: #f3f8ff;
}

/* ---------- INPUT ---------- */
.table-input {
    width: 80px;
    font-size: 13px;
    padding: 4px 6px;
    border: 1px solid #ccc;
    border-radius: 3px;
}

/* ---------- ACTIONS ---------- */
.actions {
    text-align: right;
    padding: 10px;
    background: #ffffff;
    border-top: 1px solid #e3e3e3;
}

.btn {
    font-size: 13px;
    padding: 6px 14px;
}
</style>

<div class="page">

    <!-- HEADER -->
    <div class="header d-flex justify-content-between align-items-center">
        <h3>Issue / Pack – {{ order.order_no }}</h3>
        <a href="{% url 'admin_orders' %}" class="btn btn-outline-secondary btn-sm">
            Back
        </a>
    </div>

    <!-- ERRORS -->
    {% if errors %}
    <div class="alert alert-danger">
        <ul class="mb-0">
            {% for e in errors %}
                <li>{{ e }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- META -->
    <div class="meta">
        <div><strong>Business:</strong> {{ order.queries.first.Business_name }}</div>
        <div><strong>Date:</strong> {{ order.created_at|date:"d-m-Y H:i" }}</div>
        <div><strong>Status:</strong> {{ order.get_status_display }}</div>
        <div><strong>Total Qty:</strong> {{ order.total_quantity }}</div>
        <div><strong>Total Price:</strong> {{ order.total_price }}</div>
        <div><strong>Customer:</strong> {{ order.created_by }}</div>
    </div>

    <!-- TOP SPLIT -->
    <div class="split">

        <!-- LEFT: PENDING -->
        <div>
            <div class="section-title">Pending Items (Ready to Pack)</div>

            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="issue_items">

                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all-pending"></th>
                                <th>#</th>
                                <th>Product</th>
                                <th>Ordered</th>
                                <th>Batch</th>
                                <th>Expiry</th>
                                <th>Issue Qty</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in pending_items %}
                            <tr>
                                <td><input type="checkbox" name="order_item_{{ item.id }}" class="pending-item-checkbox"></td>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ item.product_name }}</td>
                                <td>{{ item.quantity }}</td>
                                <td>{{ item.batch }}</td>
                                <td>{{ item.expiry_date }}</td>
                                <td>
                                    <input type="number"
                                           name="issue_qty_{{ item.id }}"
                                           value="{{ item.quantity }}"
                                           class="table-input">
                                </td>
                                <td>{{ item.get_status_display }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="8" style="text-align:center;color:#777;">
                                    All items are already packed.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    {% if pending_items %}
                    <div class="actions">
                        <button class="btn btn-success">
                            Mark Selected as Packed
                        </button>
                    </div>
                    {% endif %}
                </div>
            </form>
        </div>

        <!-- RIGHT: QUERY -->
        <div>
            <div class="section-title">Query Items (Missed Products)</div>

            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="convert_query_items">

                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all-queries"></th>
                                <th>#</th>
                                <th>Product</th>
                                <th>Requested</th>
                                <th>Pending</th>
                                <th>Issue Qty</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for qi in query_items %}
                            <tr>
                                <td><input type="checkbox" name="query_item_{{ qi.id }}" class="query-item-checkbox"></td>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ qi.product_name }}</td>
                                <td>{{ qi.requested_qty }}</td>
                                <td>{{ qi.pending_qty }}</td>
                                <td>
                                    <input type="number"
                                           name="query_issue_qty_{{ qi.id }}"
                                           value="{{ qi.pending_qty|default_if_none:qi.requested_qty }}"
                                           class="table-input">
                                </td>
                                <td>{{ qi.get_status_display }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" style="text-align:center;color:#777;">
                                    No query items to convert.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    {% if query_items %}
                    <div class="actions">
                        <button class="btn btn-info">
                            Convert Selected & Pack
                        </button>
                    </div>
                    {% endif %}
                </div>
            </form>
        </div>

    </div>

    <!-- PACKED ITEMS -->
    <div class="section-title" style="margin-top:26px;">
        Packed Items
    </div>

    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Product</th>
                    <th>Qty</th>
                    <th>Total</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for item in packed_items %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ item.product_name }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>{{ item.total_price }}</td>
                    <td>{{ item.get_status_display }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="text-align:center;color:#777;">
                        No packed items yet.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function () {

    document.getElementById('select-all-pending')?.addEventListener('change', function () {
        document.querySelectorAll('.pending-item-checkbox').forEach(cb => {
            cb.checked = this.checked;
            cb.closest('tr').classList.toggle('selected', this.checked);
        });
    });

    document.getElementById('select-all-queries')?.addEventListener('change', function () {
        document.querySelectorAll('.query-item-checkbox').forEach(cb => {
            cb.checked = this.checked;
            cb.closest('tr').classList.toggle('selected', this.checked);
        });
    });

    document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', function () {
            this.closest('tr')?.classList.toggle('selected', this.checked);
        });
    });
});
</script>

{% endblock %}
